<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>THE ALCHEMIST'S SANCTUM</title>
    <link href="https://fonts.googleapis.com/css2?family=Grenze+Gotisch:wght@400;700&family=IM+Fell+DW+Pica:ital@0;1&display=swap" rel="stylesheet">
    <style>
        :root {
            --paper: #c9b087;
            --ink: #2b1a0f;
            --mana: #4a90e2;
            --blood: #8b0000;
        }
        body { 
            margin: 0; overflow: hidden; background: #050403; 
            font-family: 'IM Fell DW Pica', serif; color: var(--paper); 
        }

        /* The Spellbook (Log) */
        #spellbook {
            position: absolute; bottom: 40px; right: 40px; 
            width: 320px; height: 400px; 
            background: #1a1510; border: 8px solid #3d2b1f;
            padding: 30px; box-shadow: 20px 20px 50px #000;
            transform: rotate(2deg);
            background-image: radial-gradient(circle at center, #2a2015 0%, #1a1510 100%);
        }
        #spellbook::before { content: ''; position: absolute; top: 0; left: 50%; width: 2px; height: 100%; background: rgba(0,0,0,0.5); }

        #price-tag {
            position: absolute; top: 50px; left: 50px;
            font-family: 'Grenze Gotisch', serif; font-size: 52px;
            color: var(--paper); text-shadow: 0 0 20px rgba(255,255,255,0.1);
        }

        .entry { font-size: 14px; margin-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .buy { color: var(--mana); }
        .sell { color: var(--blood); }

        canvas { display: block; filter: contrast(1.1) brightness(0.8); }
    </style>
</head>
<body>

<div id="price-tag">℥ ...</div>

<div id="spellbook">
    <div style="font-family: 'Grenze Gotisch'; font-size: 20px; text-align: center; margin-bottom: 20px;">The Ledger of Transmutation</div>
    <div id="log-content"></div>
</div>

<canvas id="screen"></canvas>

<script>
    const canvas = document.getElementById('screen');
    const ctx = canvas.getContext('2d');
    const priceDisplay = document.getElementById('price-tag');
    const logContent = document.getElementById('log-content');

    let btcPrice = 0, startDayPrice = 0;
    let smokeParticles = [], rainDrops = [];
    let flashOpacity = 0;

    function resize() {
        canvas.width = window.innerWidth * window.devicePixelRatio;
        canvas.height = window.innerHeight * window.devicePixelRatio;
        ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
    }
    window.addEventListener('resize', resize);
    resize();

    // Initialize Rain
    for(let i=0; i<100; i++) {
        rainDrops.push({ x: Math.random()*window.innerWidth, y: Math.random()*window.innerHeight, v: 10 + Math.random()*10 });
    }

    async function init() {
        const stats = await fetch('https://api.exchange.coinbase.com/products/BTC-USD/stats').then(r => r.json());
        startDayPrice = parseFloat(stats.open);

        const ws = new WebSocket('wss://ws-feed.exchange.coinbase.com');
        ws.onopen = () => ws.send(JSON.stringify({ type: "subscribe", channels: ["ticker", "matches"], product_ids: ["BTC-USD"] }));
        ws.onmessage = (e) => {
            const data = JSON.parse(e.data);
            if (data.type === 'ticker') {
                btcPrice = parseFloat(data.price);
                priceDisplay.innerText = `℥ ${btcPrice.toLocaleString()}`;
                priceDisplay.style.color = btcPrice >= startDayPrice ? '#4a90e2' : '#8b0000';
            }
            if (data.type === 'match') {
                const size = parseFloat(data.size);
                // Create Smoke Puff for every trade
                for(let i=0; i<5; i++) {
                    smokeParticles.push({
                        x: window.innerWidth * 0.2, // From the "pipe"
                        y: window.innerHeight * 0.7,
                        vx: (Math.random() - 0.2) * 2,
                        vy: -Math.random() * 2 - 1,
                        size: 5 + Math.random() * 15,
                        life: 1.0
                    });
                }
                // Lightning for big trades
                if (size > 0.5) flashOpacity = 0.5;

                const div = document.createElement('div');
                div.className = `entry ${data.side}`;
                div.innerHTML = `• ${size.toFixed(4)} BTC @ ${parseFloat(data.price).toLocaleString()}`;
                logContent.prepend(div);
                if (logContent.childNodes.length > 10) logContent.lastChild.remove();
            }
        };
    }

    function drawSanctum() {
        const w = window.innerWidth;
        const h = window.innerHeight;

        // 1. Outside the Window (Rain)
        ctx.fillStyle = '#050508';
        ctx.fillRect(w*0.5, h*0.1, w*0.4, h*0.5); // Window Frame
        
        ctx.strokeStyle = 'rgba(100, 150, 255, 0.2)';
        rainDrops.forEach(r => {
            ctx.beginPath();
            ctx.moveTo(r.x, r.y);
            ctx.lineTo(r.x - 2, r.y + 10);
            ctx.stroke();
            r.y += r.v;
            if (r.y > h) r.y = -10;
        });

        // Lightning Flash
        if (flashOpacity > 0) {
            ctx.fillStyle = `rgba(200, 230, 255, ${flashOpacity})`;
            ctx.fillRect(0,0,w,h);
            flashOpacity -= 0.02;
        }

        // 2. The Desk & Pipe Smoke
        smokeParticles = smokeParticles.filter(p => {
            ctx.fillStyle = `rgba(200, 200, 200, ${p.life * 0.2})`;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
            ctx.fill();
            p.x += p.vx; p.y += p.vy; p.life -= 0.005;
            p.size += 0.2;
            return p.life > 0;
        });

        // 3. The Candle Flame (Price Indicator)
        const flameY = h * 0.6;
        const flameX = w * 0.5;
        const flicker = Math.sin(Date.now()/100) * 2;
        const flameColor = btcPrice >= startDayPrice ? '74, 144, 226' : '139, 0, 0';
        
        const g = ctx.createRadialGradient(flameX, flameY, 0, flameX, flameY, 30);
        g.addColorStop(0, '#fff');
        g.addColorStop(0.4, `rgba(${flameColor}, 0.8)`);
        g.addColorStop(1, 'transparent');
        ctx.fillStyle = g;
        ctx.beginPath();
        ctx.arc(flameX + flicker, flameY, 15, 0, Math.PI*2);
        ctx.fill();
    }

    function frame() {
        ctx.fillStyle = '#0a0806';
        ctx.fillRect(0, 0, window.innerWidth, window.innerHeight);
        drawSanctum();
        requestAnimationFrame(frame);
    }

    init(); frame();
</script>
</body>
</html>
