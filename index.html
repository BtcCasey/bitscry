<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>THE RITUAL: ELECTRIC BLOOD</title>
    <link href="https://fonts.googleapis.com/css2?family=Grenze+Gotisch:wght@400;700&family=IM+Fell+DW+Pica&display=swap" rel="stylesheet">
    <style>
        :root {
            --blood: #8b0000;
            --lightning: #00d4ff;
            --ritual-red: #ff1111;
            --paper: #e3d3a3;
        }
        body { margin: 0; overflow: hidden; background: #050403; font-family: 'IM Fell DW Pica', serif; }
        
        #altar-ui {
            position: absolute; top: 50px; left: 50px; pointer-events: none; z-index: 100;
        }
        #price { 
            font-family: 'Grenze Gotisch', serif; font-size: 84px; color: var(--ritual-red); 
            line-height: 0.8; text-shadow: 0 0 20px var(--blood), 0 0 5px var(--lightning); 
        }
        #hash { font-size: 16px; color: var(--lightning); opacity: 0.8; margin-top: 15px; letter-spacing: 2px; font-weight: bold; }

        #log {
            position: absolute; bottom: 50px; left: 50px; width: 320px;
            max-height: 250px; overflow: hidden;
            display: flex; flex-direction: column-reverse;
            mask-image: linear-gradient(to top, black 70%, transparent 100%);
            font-size: 14px; color: var(--lightning);
        }
        .entry { padding: 4px 0; border-bottom: 1px solid rgba(0, 212, 255, 0.2); text-shadow: 0 0 5px var(--lightning); }
        
        canvas { display: block; }
    </style>
</head>
<body>

<div id="altar-ui">
    <div id="price">℥ ...</div>
    <div id="hash">LEYLINE FREQUENCY: DIVINING...</div>
</div>

<div id="log"></div>
<canvas id="screen"></canvas>

<script>
    const canvas = document.getElementById('screen');
    const ctx = canvas.getContext('2d');
    
    let state = {
        price: 0,
        history: [],
        hash: 750_000_000_000_000_000_000n,
        runes: [],
        bolts: []
    };

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    async function init() {
        const candles = await fetch('https://api.exchange.coinbase.com/products/BTC-USD/candles?granularity=300').then(r => r.json());
        state.history = candles.map(c => c[4]).reverse();

        const ws = new WebSocket('wss://ws-feed.exchange.coinbase.com');
        ws.onopen = () => ws.send(JSON.stringify({ type: "subscribe", channels: ["ticker", "matches"], product_ids: ["BTC-USD"] }));
        ws.onmessage = (e) => {
            const data = JSON.parse(e.data);
            if (data.type === 'ticker') {
                state.price = parseFloat(data.price);
                document.getElementById('price').innerText = `℥ ${state.price.toLocaleString()}`;
            }
            if (data.type === 'match') {
                createBolt(window.innerWidth/2, window.innerHeight/2);
                state.runes.push({ x: Math.random()*window.innerWidth, y: Math.random()*window.innerHeight, life: 1.0, size: 10 });
                const div = document.createElement('div');
                div.className = 'entry';
                div.innerText = `⚡ ${data.size} BTC @ ${state.price.toLocaleString()}`;
                document.getElementById('log').prepend(div);
            }
        };
        setInterval(() => {
            state.hash += BigInt(Math.floor((Math.random()-0.5)*2000000000000000));
            document.getElementById('hash').innerText = `LEYLINE PROOF: ${(state.hash / 1_000_000_000_000_000_000n)} EH/s`;
        }, 2000);
    }

    function createBolt(x, y) {
        state.bolts.push({ x, y, life: 1.0, segments: [] });
    }

    function drawStone() {
        const w = window.innerWidth, h = window.innerHeight;
        ctx.fillStyle = '#0a0908'; // Deep Slate
        ctx.fillRect(0, 0, w, h);
        
        // Stone Cracks
        ctx.strokeStyle = '#151311';
        ctx.lineWidth = 1;
        for(let i=0; i<30; i++) {
            ctx.beginPath();
            ctx.moveTo(Math.random()*w, 0); ctx.lineTo(Math.random()*w, h);
            ctx.stroke();
        }

        // Blood-Red Ritual Border
        ctx.strokeStyle = 'rgba(139, 0, 0, 0.4)';
        ctx.lineWidth = 8;
        ctx.strokeRect(30, 30, w-60, h-60);
    }

    function render() {
        const w = window.innerWidth, h = window.innerHeight;
        const cx = w/2, cy = h/2;
        const orbR = 180;
        
        drawStone();

        // 1. THE RITUAL CIRCLE
        ctx.shadowBlur = 15; ctx.shadowColor = '#ff0000';
        ctx.strokeStyle = '#ff1111';
        ctx.setLineDash([15, 25]);
        ctx.beginPath(); ctx.arc(cx, cy, orbR + 20, 0, Math.PI*2); ctx.stroke();
        ctx.setLineDash([]);
        ctx.shadowBlur = 0;

        // 2. THE SPINNING SEAL & CENTERED LEYLINE
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(Date.now() * 0.0004);
        
        // The Square Seal
        ctx.strokeStyle = 'rgba(255, 17, 17, 0.6)';
        ctx.lineWidth = 3;
        ctx.strokeRect(-orbR/1.4, -orbR/1.4, orbR*1.4, orbR*1.4);
        
        // Trapped Leyline (Centered inside the seal)
        if (state.history.length > 0) {
            const min = Math.min(...state.history);
            const max = Math.max(...state.history);
            const range = max - min;
            const graphW = orbR * 1.2;
            const graphH = orbR * 0.8;
            
            ctx.rotate(-Date.now() * 0.0004); // Counter-rotate so graph stays horizontal inside seal
            ctx.beginPath();
            ctx.strokeStyle = '#00d4ff';
            ctx.shadowBlur = 10; ctx.shadowColor = '#00d4ff';
            
            const step = graphW / state.history.length;
            state.history.forEach((p, i) => {
                const x = -graphW/2 + (i * step);
                const y = graphH/2 - ((p - min) / range * graphH);
                if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            });
            ctx.stroke();
            ctx.shadowBlur = 0;
        }
        ctx.restore();

        // 3. BLUE LIGHTNING BOLTS (Trade Impacts)
        state.bolts = state.bolts.filter(b => {
            ctx.strokeStyle = `rgba(0, 212, 255, ${b.life})`;
            ctx.lineWidth = 2;
            ctx.shadowBlur = 10; ctx.shadowColor = '#00d4ff';
            ctx.beginPath();
            let tx = b.x, ty = b.y;
            ctx.moveTo(tx, ty);
            for(let i=0; i<5; i++) {
                tx += (Math.random()-0.5)*100;
                ty -= 40;
                ctx.lineTo(tx, ty);
            }
            ctx.stroke();
            b.life -= 0.05;
            return b.life > 0;
        });

        // 4. RUNES
        state.runes = state.runes.filter(r => {
            ctx.fillStyle = '#ff1111';
            ctx.globalAlpha = r.life;
            ctx.beginPath(); ctx.arc(r.x, r.y, r.size, 0, Math.PI*2); ctx.fill();
            r.life -= 0.02;
            return r.life > 0;
        });
        ctx.globalAlpha = 1; ctx.shadowBlur = 0;

        requestAnimationFrame(render);
    }

    init(); render();
</script>
</body>
</html>
