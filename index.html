<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>THE ALCHEMIST'S SANCTUM</title>
    <link href="https://fonts.googleapis.com/css2?family=Grenze+Gotisch:wght@400;700&family=IM+Fell+DW+Pica:ital@0;1&display=swap" rel="stylesheet">
    <style>
        :root {
            --paper: #c9b087;
            --ink: #2b1a0f;
            --mana: #4a90e2;
            --blood: #8b0000;
        }
        body { 
            margin: 0; overflow: hidden; background: #050403; 
            font-family: 'IM Fell DW Pica', serif; color: var(--paper); 
        }

        /* The Spellbook Ledger */
        #spellbook {
            position: absolute; bottom: 50px; right: 80px; 
            width: 340px; height: 420px; 
            background: #2a2015; border: 12px solid #3d2b1f;
            padding: 25px; box-shadow: 30px 30px 60px rgba(0,0,0,0.9);
            transform: rotate(3deg); z-index: 10;
            background-image: linear-gradient(90deg, #1a1510 0%, #2a2015 5%, #2a2015 95%, #1a1510 100%);
        }

        #price-tag {
            position: absolute; top: 60px; left: 80px;
            font-family: 'Grenze Gotisch', serif; font-size: 58px;
            color: var(--paper); text-shadow: 3px 3px 10px rgba(0,0,0,0.8);
            z-index: 20;
        }

        .entry { font-size: 14px; margin-bottom: 6px; border-bottom: 1px solid rgba(255,255,255,0.03); opacity: 0.8; }
        .buy { color: var(--mana); }
        .sell { color: var(--blood); }

        canvas { display: block; filter: contrast(1.1) brightness(0.9); }
    </style>
</head>
<body>

<div id="price-tag">℥ ...</div>

<div id="spellbook">
    <div style="font-family: 'Grenze Gotisch'; font-size: 22px; text-align: center; margin-bottom: 15px; color: var(--gold);">The Ledger of Flux</div>
    <div id="log-content"></div>
</div>

<canvas id="screen"></canvas>

<script>
    const canvas = document.getElementById('screen');
    const ctx = canvas.getContext('2d');
    const priceDisplay = document.getElementById('price-tag');
    const logContent = document.getElementById('log-content');

    let btcPrice = 0, startDayPrice = 0;
    let smokeParticles = [], rainDrops = [];
    let flashOpacity = 0;

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // Setup Rain
    for(let i=0; i<150; i++) {
        rainDrops.push({ x: Math.random()*window.innerWidth, y: Math.random()*window.innerHeight, v: 15 + Math.random()*10 });
    }

    async function init() {
        const stats = await fetch('https://api.exchange.coinbase.com/products/BTC-USD/stats').then(r => r.json());
        startDayPrice = parseFloat(stats.open);

        const ws = new WebSocket('wss://ws-feed.exchange.coinbase.com');
        ws.onopen = () => ws.send(JSON.stringify({ type: "subscribe", channels: ["ticker", "matches"], product_ids: ["BTC-USD"] }));
        ws.onmessage = (e) => {
            const data = JSON.parse(e.data);
            if (data.type === 'ticker') {
                btcPrice = parseFloat(data.price);
                priceDisplay.innerText = `℥ ${btcPrice.toLocaleString()}`;
                priceDisplay.style.color = btcPrice >= startDayPrice ? '#4a90e2' : '#8b0000';
            }
            if (data.type === 'match') {
                const size = parseFloat(data.size);
                // Create Smoke Puff from the "Pipe" area
                for(let i=0; i<3; i++) {
                    smokeParticles.push({
                        x: window.innerWidth * 0.15, y: window.innerHeight * 0.85,
                        vx: (Math.random() - 0.1) * 1.5, vy: -Math.random() * 2 - 1,
                        size: 10, life: 1.0
                    });
                }
                if (size > 0.5) flashOpacity = 0.6; // Lightning!

                const div = document.createElement('div');
                div.className = `entry ${data.side}`;
                div.innerHTML = `• ${size.toFixed(4)} BTC @ ${parseFloat(data.price).toLocaleString()}`;
                logContent.prepend(div);
                if (logContent.childNodes.length > 12) logContent.lastChild.remove();
            }
        };
    }

    function drawRoom() {
        const w = window.innerWidth;
        const h = window.innerHeight;

        // 1. Stone Walls
        ctx.fillStyle = '#12100d';
        ctx.fillRect(0,0,w,h);
        
        // Wall texture (Cobblestone look)
        ctx.strokeStyle = '#0a0907';
        for(let i=0; i<w; i+=80) {
            for(let j=0; j<h; j+=40) {
                ctx.strokeRect(i + (j%80==0?0:40), j, 80, 40);
            }
        }

        // 2. The Window (Looking out at the storm)
        const winX = w * 0.55, winY = h * 0.1, winW = w * 0.35, winH = h * 0.5;
        ctx.fillStyle = '#050508'; // Dark outside
        ctx.fillRect(winX, winY, winW, winH);

        // Rain in the window
        ctx.strokeStyle = 'rgba(100, 150, 255, 0.15)';
        ctx.lineWidth = 1;
        rainDrops.forEach(r => {
            if (r.x > winX && r.x < winX + winW && r.y > winY && r.y < winY + winH) {
                ctx.beginPath();
                ctx.moveTo(r.x, r.y);
                ctx.lineTo(r.x - 2, r.y + 12);
                ctx.stroke();
            }
            r.y += r.v;
            if (r.y > h) r.y = -20;
        });

        // Window Panes (Leaded Glass)
        ctx.strokeStyle = '#1a1815';
        ctx.lineWidth = 6;
        ctx.strokeRect(winX, winY, winW, winH);
        ctx.beginPath();
        ctx.moveTo(winX + winW/2, winY); ctx.lineTo(winX + winW/2, winY + winH);
        ctx.moveTo(winX, winY + winH/2); ctx.lineTo(winX + winW, winY + winH/2);
        ctx.stroke();

        // 3. The Desk (Foreground)
        ctx.fillStyle = '#1e1610';
        ctx.fillRect(0, h * 0.75, w, h * 0.25);
        ctx.fillStyle = '#150f0a';
        ctx.fillRect(0, h * 0.75, w, 10); // Desk edge

        // 4. Lighting & Effects
        if (flashOpacity > 0) {
            ctx.fillStyle = `rgba(200, 230, 255, ${flashOpacity})`;
            ctx.fillRect(winX, winY, winW, winH); // Flash only the window
            ctx.fillStyle = `rgba(200, 230, 255, ${flashOpacity * 0.2})`;
            ctx.fillRect(0,0,w,h); // Slight room flash
            flashOpacity -= 0.03;
        }

        // Smoke particles from the pipe
        smokeParticles = smokeParticles.filter(p => {
            ctx.fillStyle = `rgba(180, 180, 180, ${p.life * 0.15})`;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
            ctx.fill();
            p.x += p.vx; p.y += p.vy; p.life -= 0.004;
            p.size += 0.3;
            return p.life > 0;
        });

        // 5. The Magic Candle
        const cX = w * 0.25, cY = h * 0.75;
        // Candle stick
        ctx.fillStyle = '#332211';
        ctx.fillRect(cX - 5, cY - 40, 10, 40);
        // Flame
        const flicker = Math.sin(Date.now()/80) * 3;
        const color = btcPrice >= startDayPrice ? '74, 144, 226' : '139, 0, 0';
        const g = ctx.createRadialGradient(cX + flicker, cY - 55, 0, cX + flicker, cY - 55, 40);
        g.addColorStop(0, '#fff');
        g.addColorStop(0.3, `rgba(${color}, 0.9)`);
        g.addColorStop(1, 'transparent');
        ctx.fillStyle = g;
        ctx.beginPath();
        ctx.arc(cX + flicker, cY - 55, 25, 0, Math.PI*2);
        ctx.fill();
    }

    function frame() {
        drawRoom();
        requestAnimationFrame(frame);
    }

    init(); frame();
</script>
</body>
</html>
