<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>THE ALCHEMIST'S SANCTUM</title>
    <link href="https://fonts.googleapis.com/css2?family=Grenze+Gotisch:wght@400;700&family=IM+Fell+DW+Pica:ital@0;1&display=swap" rel="stylesheet">
    <style>
        :root {
            --paper: #e3d3a3; /* Brighter parchment */
            --gold: #ffcc33;
            --mana: #4facfe;
            --blood: #ff4b2b;
        }
        body { 
            margin: 0; overflow: hidden; background: #1a1510; 
            font-family: 'IM Fell DW Pica', serif; color: #2b1a0f; 
        }

        /* The Magic Spellbook */
        #spellbook {
            position: absolute; bottom: 40px; right: 60px; 
            width: 360px; height: 480px; 
            background: var(--paper); border: 15px solid #4a3728;
            border-radius: 5px; padding: 30px; 
            box-shadow: 0 0 50px rgba(0,0,0,0.7), inset 0 0 100px rgba(0,0,0,0.1);
            transform: perspective(1000px) rotateY(-5deg) rotateX(5deg);
            z-index: 10;
            background-image: linear-gradient(to right, rgba(0,0,0,0.2) 0%, transparent 5%, transparent 95%, rgba(0,0,0,0.2) 100%);
        }

        #price-tag {
            position: absolute; top: 40px; left: 60px;
            font-family: 'Grenze Gotisch', serif; font-size: 64px;
            color: var(--gold); text-shadow: 2px 2px 15px rgba(0,0,0,0.5);
            z-index: 20;
        }

        .entry { font-size: 15px; margin-bottom: 8px; border-bottom: 1px solid rgba(0,0,0,0.1); font-weight: bold; }
        .buy { color: #0066cc; }
        .sell { color: #990000; }

        canvas { display: block; filter: saturate(1.2); }
    </style>
</head>
<body>

<div id="price-tag">â„¥ ...</div>

<div id="spellbook">
    <div style="font-family: 'Grenze Gotisch'; font-size: 26px; text-align: center; margin-bottom: 20px; color: #4a3728; border-bottom: 2px solid #4a3728;">Incantations of the Tape</div>
    <div id="log-content"></div>
</div>

<canvas id="screen"></canvas>

<script>
    const canvas = document.getElementById('screen');
    const ctx = canvas.getContext('2d');
    const priceDisplay = document.getElementById('price-tag');
    const logContent = document.getElementById('log-content');

    let btcPrice = 0, startDayPrice = 0, priceTrend = 1; 
    let smokeParticles = [], rainDrops = [], bubbles = [];
    let flashOpacity = 0;

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // Rain
    for(let i=0; i<150; i++) rainDrops.push({ x: Math.random()*window.innerWidth, y: Math.random()*window.innerHeight, v: 12 + Math.random()*8 });

    async function init() {
        const stats = await fetch('https://api.exchange.coinbase.com/products/BTC-USD/stats').then(r => r.json());
        startDayPrice = parseFloat(stats.open);

        const ws = new WebSocket('wss://ws-feed.exchange.coinbase.com');
        ws.onopen = () => ws.send(JSON.stringify({ type: "subscribe", channels: ["ticker", "matches"], product_ids: ["BTC-USD"] }));
        ws.onmessage = (e) => {
            const data = JSON.parse(e.data);
            if (data.type === 'ticker') {
                btcPrice = parseFloat(data.price);
                priceTrend = btcPrice >= startDayPrice ? 1 : -1;
                priceDisplay.innerText = `â„¥ ${btcPrice.toLocaleString()}`;
                priceDisplay.style.color = priceTrend === 1 ? '#4facfe' : '#ff4b2b';
            }
            if (data.type === 'match') {
                const size = parseFloat(data.size);
                // Smoke puff
                for(let i=0; i<4; i++) smokeParticles.push({ x: window.innerWidth * 0.1, y: window.innerHeight * 0.8, vx: Math.random(), vy: -2, size: 8, life: 1.0 });
                // Vial bubbles
                bubbles.push({ x: window.innerWidth * 0.4 + (Math.random()*20-10), y: window.innerHeight * 0.75, v: 1+Math.random()*2, life: 1.0 });
                
                if (size > 0.5) flashOpacity = 0.4;

                const div = document.createElement('div');
                div.className = `entry ${data.side}`;
                div.innerHTML = `ðŸ“œ ${size.toFixed(4)} BTC @ ${parseFloat(data.price).toLocaleString()}`;
                logContent.prepend(div);
                if (logContent.childNodes.length > 12) logContent.lastChild.remove();
            }
        };
    }

    function drawSanctum() {
        const w = window.innerWidth, h = window.innerHeight;

        // 1. Brightened Walls
        ctx.fillStyle = '#2c241e'; // Warmer brown
        ctx.fillRect(0,0,w,h);
        
        // Wall Detail
        ctx.strokeStyle = '#3d3229';
        for(let i=0; i<w; i+=100) {
            for(let j=0; j<h; j+=50) {
                ctx.strokeRect(i + (j%100==0?0:50), j, 100, 50);
            }
        }

        // 2. Window with Glow
        const winX = w * 0.55, winY = h * 0.1, winW = w * 0.35, winH = h * 0.45;
        ctx.fillStyle = '#0a0d14';
        ctx.fillRect(winX, winY, winW, winH);

        // Rain
        ctx.strokeStyle = 'rgba(150, 200, 255, 0.2)';
        rainDrops.forEach(r => {
            if (r.x > winX && r.x < winX + winW && r.y > winY && r.y < winY + winH) {
                ctx.beginPath(); ctx.moveTo(r.x, r.y); ctx.lineTo(r.x - 1, r.y + 8); ctx.stroke();
            }
            r.y += r.v; if (r.y > h) r.y = -20;
        });

        // Window Frame
        ctx.strokeStyle = '#4a3728'; ctx.lineWidth = 10;
        ctx.strokeRect(winX, winY, winW, winH);

        // 3. The Desk
        ctx.fillStyle = '#3d2b1f';
        ctx.fillRect(0, h * 0.7, w, h * 0.3);
        ctx.fillStyle = '#4a3728';
        ctx.fillRect(0, h * 0.7, w, 15);

        // 4. THE COINS (Height based on Price vs Open)
        const coinCount = Math.max(0, Math.min(20, (btcPrice - startDayPrice) / 10));
        ctx.fillStyle = '#d4af37';
        for(let i=0; i<coinCount; i++) {
            ctx.beginPath();
            ctx.ellipse(w * 0.7, h*0.7 - (i*5), 30, 10, 0, 0, Math.PI*2);
            ctx.fill();
            ctx.stroke();
        }

        // 5. THE TOAD (Sits on the left)
        ctx.fillStyle = '#4d5d3f';
        ctx.beginPath();
        ctx.ellipse(w * 0.1, h * 0.72, 35, 20, 0, 0, Math.PI*2); // Body
        ctx.fill();
        ctx.fillStyle = '#2d3d1f';
        ctx.beginPath(); ctx.arc(w * 0.08, h * 0.7, 8, 0, Math.PI*2); ctx.fill(); // Eyes
        ctx.beginPath(); ctx.arc(w * 0.12, h * 0.7, 8, 0, Math.PI*2); ctx.fill();

        // 6. THE BUBBLING VIAL
        const vX = w * 0.4, vY = h * 0.73;
        ctx.fillStyle = 'rgba(255,255,255,0.2)';
        ctx.fillRect(vX - 20, vY - 60, 40, 60); // Glass
        ctx.fillStyle = priceTrend === 1 ? 'rgba(79, 172, 254, 0.6)' : 'rgba(255, 75, 43, 0.6)';
        ctx.fillRect(vX - 18, vY - 10 - (Math.abs(btcPrice % 40)), 36, Math.abs(btcPrice % 40) + 8);
        
        bubbles = bubbles.filter(b => {
            ctx.fillStyle = 'rgba(255,255,255,0.4)';
            ctx.beginPath(); ctx.arc(b.x, b.y, 3, 0, Math.PI*2); ctx.fill();
            b.y -= b.v; b.life -= 0.02;
            return b.life > 0;
        });

        // 7. Smoke & Lighting
        if (flashOpacity > 0) {
            ctx.fillStyle = `rgba(255, 255, 255, ${flashOpacity})`;
            ctx.fillRect(winX, winY, winW, winH);
            flashOpacity -= 0.04;
        }

        smokeParticles = smokeParticles.filter(p => {
            ctx.fillStyle = `rgba(200, 200, 200, ${p.life * 0.3})`;
            ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
            p.x += p.vx; p.y += p.vy; p.life -= 0.005; p.size += 0.2;
            return p.life > 0;
        });

        // Magic Aura
        const g = ctx.createRadialGradient(w*0.5, h*0.5, 0, w*0.5, h*0.5, w*0.8);
        g.addColorStop(0, 'transparent');
        g.addColorStop(1, 'rgba(0,0,0,0.4)');
        ctx.fillStyle = g; ctx.fillRect(0,0,w,h);
    }

    function frame() {
        drawSanctum();
        requestAnimationFrame(frame);
    }

    init(); frame();
</script>
</body>
</html>
